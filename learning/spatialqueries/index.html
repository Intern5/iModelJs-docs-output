<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Spatial Queries - iModelJs</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="https://imodeljs.github.io/iModelJs-docs-output//styles/bundle.css">
    <link rel="stylesheet" type="text/css" href="https://imodeljs.github.io/iModelJs-docs-output//styles/prism.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet"> 
        <link rel='shortcut icon' type='image/x-icon' href='https://imodeljs.github.io/iModelJs-docs-output//overview/imodeljs.ico' /> 
</head>

<body data-site-root=https://imodeljs.github.io/iModelJs-docs-output// class='layout-index '>
    <span id="contentLoader">
        <p>Woah! This page has a great deal of content... Give us a second to load it.</p>
    </span>
    <span id="contentLoaderBackground"></span>
    <div id="flex-wrapper">
        <header id="main-header">
            <div class='row nav-container'>
                <nav id='main-navbar' class="navbar navbar-expand-md navbar-light">
                    
                    <button class="navbar-toggler navbar-toggler-left custom-toggler" type="button" aria-controls="navbarSupportedContent" aria-expanded="false"
                        aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon">
                            <i class='icon icon-menu'></i>
                        </span>
                    </button>
                    <div class="nav-title-container">
                        <a class="navbar-brand " href="https://imodeljs.github.io/iModelJs-docs-output//" class="col-md-3">
                            <img id="site-logo" class="site-logo" src="https://imodeljs.github.io/iModelJs-docs-output//overview/imodeljs.ico" />
                            <h1 id="site-title">iModelJs</h1>
                        </a>
                    </div>
                    <div id='header-tabs' class='col-sm-6 col-md-3 nav-tabs-container'>
                        <nav class="navbar navbar-expand-md navbar-light">
                             <ul class="bwc-tabs-horizontal green"><li class=""><a href="https://imodeljs.github.io/iModelJs-docs-output//overview">Overview</a></li><li class=""><a href="https://imodeljs.github.io/iModelJs-docs-output//getting-started">Getting Started</a></li><li class=""><a href="https://imodeljs.github.io/iModelJs-docs-output//bis">BIS</a></li><li class="active"><a href="https://imodeljs.github.io/iModelJs-docs-output//learning">Learning</a></li><li class=""><a href="https://imodeljs.github.io/iModelJs-docs-output//reference">API Reference</a></li></ul> 
                        </nav>
                    </div>                </nav>
            </div>

        </header>
        
<div id='main-wrapper'>
    <div id='table-of-contents'>
        <span class='search-bar'>
          <li>
            <div id='search-container'>
            </div>
          </li>
        </span>
        
        <ul id='main-navigation-list'>
            <html><head></head><body><h3 id="the imodeljs library"><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/" class="table-of-contents-link">The iModelJs Library</a></h3>
        <ul>
        <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/frontend/" class="table-of-contents-link">Frontend</a></li>
        <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/backend/" class="table-of-contents-link">Backend</a></li>
        <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/common/" class="table-of-contents-link">Common</a></li>
        </ul>
        <hr>
        <p>&#xA0;</p>
        <h3 id="helpful links">Helpful links</h3>
        <ul>
        <li><a href="https://imodeljs.github.io/iModelJs-docs-output//./learning/ecsql" class="table-of-contents-link">ECSQL</a></li>
        <li><a href="https://imodeljs.github.io/iModelJs-docs-output//./learning/wireformat" class="table-of-contents-link">Wire Format</a></li>
        <li><a href="https://imodeljs.github.io/iModelJs-docs-output//./learning/faq" class="table-of-contents-link">Frequently asked Questions</a></li>
        <li><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/guidelines/" class="table-of-contents-link">Guidelines and Tips</a></li>
        <li><a href="https://imodeljs.github.io/iModelJs-docs-output//./learning/glossary" class="table-of-contents-link">iModelJs Glossary</a></li>
        </ul>
        </body></html>
        </ul>    </div>
    <div class='row documentation-main'>
        <article id="main" name="main-content">
            <div class='bread-crumb-label'><a href="https://imodeljs.github.io/iModelJs-docs-output//learning/">learning</a> > SpatialQueries</div>
            <h1 id="spatial queries">Spatial Queries</h1>
<p><a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/ecsql'>ECSQL</a> allows you to use the BisCore.SpatialIndex to include spatial criteria when selecting <a href='https://imodeljs.github.io/iModelJs-docs-output//./reference/imodeljs-backend/elements/spatialelement'>SpatialElement</a>. There are also <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/geometrysqlfuncs'>functions</a> that allow you to include an element&apos;s geometric properties in a where clause.</p>
<p>The <a href='https://imodeljs.github.io/iModelJs-docs-output//./reference/imodeljs-backend/elements/spatialelement'>SpatialElement</a> in an iModel are indexed by a <a href="https://sqlite.org/rtree.html">spatial index</a>. This indexes elements by area. Each node in the spatial index is conceptually a bounding box, plus the ECInstanceId of an element that is enclosed by it.</p>
<p>ECSQL identifies the spatial index using the name <code>BisCore.SpatialIndex</code>. You can use this name to include the spatial index in ECSQL select statements, to help filter results using spatial criteria. Conceptually, each node has the following properties: ECInstanceId, MinX, MaxX, MinY, MaxY, MinZ, and MaxZ. The nodes in the spatial index can be selected by testing their properties directly. Here is an example that is adapted from the <a href="https://sqlite.org/rtree.html">SQLite docs</a>:</p>
<pre class="no-line-numbers"><code class="language-sql">SELECT ECInstanceId FROM BisCore.SpatialIndex WHERE minX&gt;=-81.08 AND maxX&lt;=-80.58 AND minY&gt;=35.00  AND maxY&lt;=35.44
</code></pre>
<p>Nodes in the spatial index can also be selected using the special <code>MATCH</code> keyword and the special builtin spatial index matching function. The MATCH clause acts like a sub-selection that generates a set of ECInstanceIds, which it gathers from the nodes that match the specified criteria.The matching function is:</p>
<pre class="no-line-numbers"><code class="language-sql">iModel_spatial_overlap_aabb(bbox)
</code></pre>
<p>which selects all nodes that overlap a specified axis-aligned <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/geometrysqlfuncs/#imodel_bbox'>bounding box</a>. Here is an example:</p>
<pre class="no-line-numbers"><code class="language-sql">SELECT rt.ECInstanceId FROM BisCore.SpatialIndex rt WHERE (rt.ECInstanceId MATCH iModel_spatial_overlap_aabb(:bbox))
</code></pre>
<p>The caller would bind the <code>bbox</code> parameter in this example to an <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/geometrysqlfuncs/#imodel_bbox'>iModel_bbox</a> value. For example:</p>
<pre class="no-line-numbers"><code class="language-typescript">  public static queryBarriersHitByRobot(iModelDb: IModelDb, rid: Id64Props): Id64Props[] {
    const robot1 = iModelDb.elements.getElement(rid) as Robot;

    const selStmt =
      `SELECT rt.ECInstanceId FROM BisCore.SpatialIndex rt WHERE rt.ECInstanceId MATCH iModel_spatial_overlap_aabb(:bbox) AND rt.ECInstanceId &lt;&gt; :thisRobot`;

    return iModelDb.withPreparedStatement(selStmt, (stmt: ECSqlStatement) =&gt; {
      stmt.bindRange3d(&quot;bbox&quot;, robot1.placement.calculateRange());
      stmt.bindId(&quot;thisRobot&quot;, rid);
      const hits: Id64Props[] = [];
      while (stmt.step() === DbResult.BE_SQLITE_ROW) {
        hits.push(stmt.getValue(0).getId());
      }
      return hits;
    });
  }
</code></pre>
<p>This example shows how to find all elements with ranges that (may) overlap the range of some seed element. Note how the bbox parameter is bound to the range of the seed element. The additional test in the WHERE filters out the seed element, so that only other overlapping elements are found.</p>
<p>Often, a spatial query will combine a test on the spatial index with additional filtering criteria in the WHERE clause. As noted in the <a href="https://sqlite.org/rtree.html">SQLite docs</a>, &quot;An R*Tree index does not normally provide the exact answer but merely reduces the set of potential answers from millions to dozens.&quot; The additional filtering criteria are used to refine the answer after the spatial filter has narrowed the possibilities. For example, to select only elements in the specified range that are also in a specified Category:</p>
<pre><code class="language-`sql">SELECT rt.ECInstanceId FROM BisCore.SpatialIndex rt, BisCore.SpatialElement el WHERE (rt.ECInstanceId MATCH iModel_spatial_overlap_aabb(:bbox)) AND (el.ECInstanceId=rt.ECInstanceId) AND (el.Category = :categoryId)
</code></pre>
<p><em>Tip:</em> The OR operator should not be used in a WHERE clause that contains a spatial index MATCH.</p>
<p>The <a href='https://imodeljs.github.io/iModelJs-docs-output//./learning/geometrysqlfuncs'>ECSQL built-in geometry functions</a> are sometimes used along with spatial queries as additional WHERE criteria.</p>

            <p class='last-updated'>Last Updated:
                <span class='date-updated'>16 July, 2018 @ 08:07:35 pm -04:00</span>
            </p>

            
            <script type="text/javascript">
            
            </script>        </article>
    </div>
    <div id='inner-table-of-contents'>
        <!--
            - If the page is active
            - Get all headings and subheadings and list them
         -->
        
        
        
        
        
    </div>
</div>


    <footer id='main-footer'>
        <div id='footer-content-container'>
           <div class='footer-footer'>
               <p>Copyright 2018 Bentley Systems, Incorporated</p>
            </div>
        </div>
    </footer>
</div>
    <a href="javascript:" id="return-to-top"><i class="icon icon-chevron-up"></i></a>
    <script src="https://imodeljs.github.io/iModelJs-docs-output//scripts/bundle.js" ></script>
</body>

</html>